<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <!-- Must make sure this page does not cache as there are constant changes getting new data ids -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
        <meta http-equiv="Pragma" content="no-cache"/>
        <meta http-equiv="Expires" content="-1"/>
        <title>Newberry French Transcription</title>
        <link type="text/css" href="css/custom-theme/jQuery.css" rel="Stylesheet" />
        <link type="text/css" href="css/newberryFrenchSkin.css" rel="Stylesheet" />
        <script type="text/javascript" src="js/newberry.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
        <script src="https://use.fontawesome.com/4ae676603d.js"></script>
    </head>    
    <style>
        p{
            padding: 0px 10px;
        }
        .magnifyHelp{
            position: absolute;
            top: 1rem;
            right: 1rem;
            margin: 0 auto;
            background-color: rgb(255,252,227);
            padding: 0;
            color: #666;
            text-align: center;
            z-index: 3;
            display: none;
            box-shadow: 0 0 5px rgba(0,0,0,0.34);
            opacity: .85;
        }
        .magnifyHelp p {
            white-space: nowrap;
            margin: 0;
            padding: .25em;
        }
        
        .magifyHelp button{
            width: 35px;
        }
        
        .parsingHdr{
            margin-left: 20px;
        }
        optgroup{
            background-color: grey;
            color: #002a5c;
        }
        
    </style>
    <body>
        <div class="pageTurnCover">
            <div class="turnMsg">Please wait while we load the page...</div>
            <div class="turnLoader"><img src="images/loading2.gif" /></div>
        </div>
        <div class="topTrim navigation">
            <span class="trimSection"><span id="trimTitle">TITLE</span></span>
            <span class="trimSection">
                <span id="trimPage"></span>
                <!-- DO NOT add class exitPage.  It will try to fire the bulk update, which is not needed and will break the interface. -->
                <a class="" id="prevCanvas" onclick="previousFolio();" title="Previous Page">
                    <i class="fa fa-caret-left fa-2x"></i>
                </a>
                <select id="pageJump">
                    <option id="activePage" folioNum="0">Jump to Page</option>
                </select>
                <!-- DO NOT add class exitPage.  It will try to fire the bulk update, which is not needed and will break the interface. -->
                <a class="" id="nextCanvas" title="Next Page" onclick="nextFolio();">
                    <i class="fa fa-caret-right fa-2x"></i>
                </a>
            </span>
            <span class="trimSection" id="currentUser">
                <span id="trimCurrentUser"></span></span>
<!--            <span class="trimSection">Help</span> -->
            <div class="trimDividor" style="position:absolute;right:0;top:0;z-index: 1;">
                <span class="trimSection">
                    <span class="fa fa-pencil"></span><a id="homeBtn" title="My Paleography Projects" href="" ></a>
                </span>
                <span class="trimSection">
                    <a id="projectsBtn" class="exitPage wBtn ui-state-default ui-button" target="_blank" title="Share Transcriptions" href=""></a>
                    <span class="fa fa-group"></span>       
                </span>
                <span class="trimSection"><a id="helpContact" title="Contact the French Paleography team" href="" target="_blank"></a><span class="fa fa-comment"></span></span> 
                <span class="trimSection"><a id="helpMe" title="Get Help"></a><i class="fa fa-question" aria-hidden="true"></i></span>
                <span class="trimSection videoSection">
                    <a id="videoBtn_trans" class="videoBtn wBtn ui-state-default ui-button" title="See help video!" onclick="openHelpVideo('https://centerfordigitalhumanities.github.io/TPEN_Videos/tpen_newberry.html');"><span class="vInvert"></span></a>
                </span>
            </div>
        </div>

        <div class="instructions">
            <p>
                The area below accepts a local project ID number, a project or IIIF manifest url, or a valid T-PEN or IIIF manifest JSON object as valid input.  It will then load a manifest
                to the interface for you to interact with the transcription tool.  You can click 'correct parsing' to edit the line parsings.  
                You can click the forward and backwards button in the transcription
                workspace to move through the lines on the current page or the pages in the manifest.  You can use the same arrows at the very top next to the 
                'jump to page' module to do this as well.  You can also select the specific page you want to jump to.  
                The split page tools allow you to place something next to your transcription interface.  You can view other pages in the manifest or tools from outside sources
                (like dictionaries or an abbreviation list).  Try them out.  If you get stuck or want to load a new manifest, refresh the page.  
            </p>
            <p>
                Once you have decided what to put into the area, click 'Load Transcription' to have the input created into the transcription interface.  
            </p>
        </div>
        
        <div id="setTranscriptionObjectArea">
            <textarea id="transcriptionText" placeholder="Enter a line transcription"></textarea>
        </div>
        
        <button id="loadBtn" class="hideme" onclick="loadTranscription();"> Load Transcription </button> 
        <div id="transTemplateLoading">
            <p>Please wait while we load the transcription interface.  This may take up to 2 minutes.  A message will appear here if there is an error.</p>
            <div class="turnLoader transLoader"><img src="images/loading2.gif" /></div>
        </div>
        <div class="centerInterface">
        <div id="transcriptionTemplate">
            <div class="magnifyHelp">
                <p>Return to Transcribing: <kbd>ESC</kbd> or double-click</p>
                <p>
                    <span id="zoomat"></span>
                    Zoom in: <kbd>+</kbd> Zoom out: <kbd>-</kbd> </p>
            </div>
            <div id="templateResizeBar"></div>
            <div id="parsingCover">
                
            </div>
            <div id="transcriptionCanvas">
                <div id="noLineWarning">
                    <div id="noLineConfirmation">This canvas has no lines. You must be an admin to create lines.
                    <span style="color: red;" onclick="$('#noLineWarning').hide()">dismiss this message</span>.</div>
                </div>
                <div id="imgTop">
                  <img class="transcriptionImage"/>
                  <div class="lineColIndicatorArea">
                  </div>
                </div>
                <div id="transWorkspace">
                    <div id="lineUpdateNotice">
                        <div class="luMsg">Saving line...</div>
                        <div class="luLoader"><img src="images/loading2.gif" /></div>
                    </div>
                    <div title="Slide Workspace" class="workspaceHandle slideHandleLeft"><i class="fa fa-bars"></i><i class="fa fa-arrows-v"></i></div><div title="Slide Workspace" class="workspaceHandle slideHandleRight"><i class="fa fa-arrows-v"></i><i class="fa fa-bars"></i></div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend">
                        </div>
                        <div class="flex-wide" style="position:relative;height:1em;">
<!--                            <div id="contribution"></div>
                            <div id="saveReport"></div>-->
                        </div>
                        <div class="flex-bookend">
                        </div>
                    </div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend">
                        </div>
                        <div id="captions" class="flex-wide">
                            <div title="Previous Line" id="prevColLine"></div>
                            <div id="captionsText"></div>
                            <span id="notes" class="quiet">&nbsp;</span>
                        </div>
                        <div class="flex-bookend">
                        </div>
                    </div>
                    <div class="flex-container flex-stretch">
                        <div class="flex-bookend">
                            <div id="pageLabel">Page</div>
                            <button id="prevPage" title="Previous Page" onclick="previousFolio();">
<!--                                <i class="fa fa-caret-left fa-2x"></i>-->
                                Prev
                            </button>
                            <button id="nextPage" title="Next Page" onclick="nextFolio();">
<!--                                <i class="fa fa-forward fa-2x"></i>-->
                                Next
                            </button>
                        </div>
                        <div id="transcriptletArea" class="flex-wide">
                            <div title="Current Line" id="currentColLine"></div>
                            <div class="xmlClosingTags"></div>
                        </div>

                        <div class="flex-bookend">
                            <div id="lineLabel">Line <span class="lineHotkeys">(alt + &UpArrow; or &DownArrow;)</span></div>
                            <button id="prevLine" title="Previous Line" onclick="previousTranscriptlet();">
<!--                                <i class="fa fa-chevron-left"></i> -->
                                Prev
                            </button>
                            <button id="nextLine" title="Next Line" onclick="nextTranscriptlet();">
                                Next 
                                <!--<i class="fa fa-chevron-right"></i>-->
                            </button>
                            
<!--                            <button id="toggleNotes" class="pull-left clear-left" role="button" onclick="$('.notes').fadeToggle('slow')" title="Toggle Notes">
                                Notes <i class="fa fa-comment"></i>
                            </button>-->
                        </div>
                    </div>
                    <div class="flex-container flex-stretch buttons let">
                        <select id="splitScreenTools" > 
                             <option id="activeSplitTool" disabled>Tools and Info</option> 
                            <optgroup label="French Paleography Resources">
                                <option splitter='partialTrans' class="splitTool" >Partial Transcriptions</option>
                                <option splitter='essay' class="splitTool" >Background Essay</option>
                                <option splitter='scripts' class="splitTool" >French Scripts and Hands</option>
                                <option splitter='frenchdocs' class="splitTool" >About French Documents</option>
                                <option splitter='fInstitutions' class="splitTool" >French Institutions</option>
                                <option splitter='maps' class="splitTool" >Historical Maps</option>
                             </optgroup>
                             <optgroup label="Paleography Information">
                                <option splitter='start' class="splitTool" >Get Started</option>
                                <option splitter='dictionary' class="splitTool" >Dictionaries</option>
                                <option splitter='glossary' class="splitTool" >Glossary</option>
                                <option splitter='abbrev' class="splitTool" >Abbreviations</option>
                                <option splitter='calligraphy' class="splitTool" >Calligraphy Books</option>
                                <option splitter='conservation' class="splitTool" >Manuscript Preservation</option>
                                <option splitter='teachers' class="splitTool" >Teaching</option>
                                <option splitter='group' class="splitTool" >Group Work</option>
                                <option splitter='conventions' class="splitTool" >Transcribing & Editing Conventions</option>
                             </optgroup>
                             <optgroup label="Other Tools">
                                <option splitter='preview' class="splitTool" >Text Preview</option>
                                <option splitter='fullPage' class="splitTool"  >View Full Page</option>
                                <option splitter='compare' class="splitTool" >Compare Page</option>
                             </optgroup>
                         </select>  
                        <button id="canvasControls" class="let" title="Page Tools">
                            Page Tools
                            <i class="fa fa-file-image-o"></i>
                        </button>
<!--                        <button style="display:inline-block;" id="ltrSwitch" title="Change Interface">
                            LTR
                            <i class="fa fa-beer"></i>
                        </button>
                        <button style="display:inline-block;" id="rtlSwitch" title="Change Interface">
                            RTL
                            <i class="fa fa-file-image-o"></i>
                        </button>-->
                        <button id="zoomLock" class="let" onclick="toggleLocking();" title="Peek Zoom Lock Setting">
                            Zoom Lock
<!--                        <i class="fa fa-picture-o" style="color: #999;background: #DDD;border-radius: 2px;"></i>-->
                        </button>
                        <button id="magnify1" class="magnifyBtn let" magnifyImg="trans" title="Inspect Transcription Image" >
                            Inspect
                            <i class="fa fa-search-plus"></i>
                        </button> <!--Page event on the listener for this class in js.-->
                        <button id="toggleChars" title="Special Characters" onclick="toggleSpecialChars(event);">
                            Characters
                            <i class="fa fa-keyboard-o"></i>
                        </button>
                        <button id="toggleXML" class="let" title="Expansions" onclick="toggleXMLTags(event);">
                            Expansion
                            <i class="fa fa-code"></i>
                        </button>
                    </div>
                    <div class="flex-container flex-stretch" style="flex-wrap: wrap; justify-content: space-around;">
                        <div id="specialCharsFloat" class="flex-container special-charactered">
                            <div id="charactersPopin" class="specialCharacters"  title="Special Characters" >
                            </div>
                            <a title="Edit Special Characters" class="lookLikeButtons editButtons exitPage" href="buttons.jsp">
                                Edit <i class="fa fa-edit"></i>
                            </a>
                        </div>
                        <div id="xmlTagFloat" class="flex-container xml-tagged">
                            <div id="xmlTagPopin" class="xmlTags" title="Custom XML Tags">
                            </div>
                            <a title="Edit XML Tags" class="lookLikeButtons editButtons exitPage" href="buttons.jsp">
                                Edit <i class="fa fa-edit"></i>
                            </a>
                        </div>
                    </div>
                </div>
              <div id="imgBottom">
                <img class="transcriptionImage" />
                <div class="lineColIndicatorArea"></div>
              </div><br>
            </div>
        </div>
        
         <div id="parsingSplit" class="split" >
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div class="toolLinks">
                <!-- tool buttons for parsing -->
                </div>
                
                <div id="parsingDiv" class="">
                    <button id="commitParsing" onclick="showLocalChangesNotice(true);" disabled="disabled">Save Changes</button> 
                    <div style="margin-top: 35px;">Any lines or columns that are created or edited are saved automatically.  This is also true for edits made in the full page transcription interface.</div>
                    <div id="parseOptions">
                        <h3 class="parsingHdr">Line Parsing</h3>
                        <div id="ctrlColumnsInst" class="actions">
                            <h4 id="ctrlColumns" title="Make adjustments at the column level" class="clear-left">Column Controls</h4>
                                <div class="parsingToolButtons">
                                    <span id="createColumn" class="tpenButton" title="Create new columns by clicking and dragging" show="createColumnInst">Create Columns</span>
                                    <span id="adjustColumn" class="tpenButton" title="Adjust created column and clicking and dragging a side" show="adjustColumnInst">Adjust Columns</span>
                                    <span id="destroyColumn" class="tpenButton" title="Remove an entire column and its data with a click" show="destroyColumnInst">Destroy Columns</span>
                                    <span id="clearColumns" class="tpenButton" title="Clear the page, removing all transcription information" show="clearColumnsInst">Clear Page</span>
                                </div>
                                <div class="activeParsingTool">
                                    <div class="startHide" id="createColumnInst">
                                        <dl>
                                            <dt>New Column:</dt>
                                            <dd>Click and drag to place</dd><br>
                                        </dl>
                                    </div>
                                    <div class="startHide" id="adjustColumnInst">
                                        <dl>
                                            <dt>Adjustments:</dt>
                                            <dd>Drag the edges of an existing column</dd>
                                        </dl>
                                    </div>
                                    <div class="startHide" id="destroyColumnInst">
                                        <p class="">Click a column to remove all lines and transcription data it contains from the project.</p>
                                        <span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>This is a destructive process and cannot be undone.</span></p>
                                    </div>
                                    <div class="startHide" id="clearColumnsInst">
                                        <p class="">Click to clear the page, removing all transcription information.</p>
                                        <span class="destroyPage" class="tpenButton ui-state-error" title="Destroy all columns on this page"><span class="left ui-icon ui-icon-circle-close"></span>Destroy All Data</span>
                                        <p class="small"><span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>This is a destructive process and cannot be undone.</span><br />
                                         </p>
                                    </div>
                                </div>
                        </div>
                        <div id="ctrlLinesInst" class="actions">
                            <h4 id="ctrlLines" title="Make adjustments at the line level" class="clear-left">Line Controls</h4>
                                <div class="parsingToolButtons">
                                    <span id="addLines" class="tpenButton" title="Split lines to create new ones in a column" show="addLinesInst">Add Lines</span>
                                    <span id="mergeLines" class="tpenButton" title="Merge two lines or remove the last line from a column" show="mergeLinesInst">Merge Lines</span>
                                    <span id="adjustLines" class="tpenButton" title="Simple adjustments to individual lines" show="adjustLinesInst">Adjust Lines</span>                      
                                    <span id="removeLines" class="tpenButton" title="Delete the last line of a column" show="removeLinesInst">Remove Last Line</span>                      
                                </div>
                                <div class="activeParsingTool">
                                    <div class="startHide" id="addLinesInst">
                                        <p class="">Click within the shaded area to define the bottom of the new line.</p>
                                        <p class="small"><span class="inline ui-icon ui-icon-check"></span>This method retains all your <acronym title="Text, markup, and notes saved for lines within this column will remain attached.">transcription information</acronym>.<br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>Any <acronym title="text, markup, and notes">transcription information</acronym> will remain with the line above where you click.</span><br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>To add a line outside of the defined columns, <span class="ui-button loud" onclick="$('#ctrlColumns').click();$('#createColumn').click();" title="Click to use the Create a Column option">Create a Column</span>.</span></p>
                                        <div align="center">
                                            <p class="clear-left">Trouble seeing the ruler? Change the color below.</p>
                                            <div id="sampleRuler"></div>
                                            <label for="black"><input onclick="rulerColor('black');" CHECKED type="radio" value="black" name="rulerColor"/>Black</label>
                                            <label for="white"><input onclick='rulerColor("white");' id="white" type="radio" value="white" name="rulerColor"/>White</label>
                                            <input style="width:80px;" title="Type the name of any valid HTML color or code. If the code is invalid, a default color will be shown." type="text" id="customRuler" onkeyup="rulerColor('custom');" placeholder="transparent" value="transparent"/>
                                        </div>                  
                                    </div>
                                    <div class="startHide" id="mergeLinesInst">
                                        <p class="">Click within the shaded area to merge the highlighted lines.</p>
                                        <p class="small"><span class="inline ui-icon ui-icon-info"></span>This method combines your <acronym title="Text, markup, and notes saved for lines within this column will remain attached.">transcription information</acronym> into the new line.<br />
                                        <span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>If a line is removed, so in the information associated <acronym title="text, markup, and notes">with it</acronym>.</span> <br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>To add a line, use the <span class="ui-button loud" onclick="$('#addLines').click();" title="Click to use the Add Lines option">Add Lines</span> option.</span></p>
                                    </div>
                                    <div class="startHide" id="removeLinesInst">
                                        <p class="">Click within the shaded area to delete the <b>last line</b> of a column.</p>
                                        <span class="ui-state-error-text"><span class="inline ui-icon ui-icon-alert"></span>If a line is removed, so is the information associated <acronym title="text, markup, and notes">with it</acronym>.</span> <br />
                                    </div>
                                    <div class="startHide" id="adjustLinesInst">
                                        <p class="">Click and drag the right side of the line to contain the line accurately.</p>
                                        <p class="small"><span class="inline ui-icon ui-icon-check"></span>This method retains all your <acronym title="Text, markup, and notes saved for each line will remain attached.">transcription information</acronym>.<br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>Only the right boundary can be moved in this tool.</span><br />
                                        <span><span class="inline ui-icon ui-icon-info"></span>Make precise, individual changes in the transcription view on the currently selected line.  
                                            Hold the ALT key and drag the right side of a line to resize it.  While holding the ALT key
                                        press the left and right arrows to 'bump' the line.</span></p>
                                    </div>
                                </div>
                        </div>
                        <div id="editTransButtons" class="actions">
                            <h4 id="editBtns" title="Edit available XML Tags and Special Characters" class="clear-left">Workspace Tags & Chars</h4>
                            <a title="Edit Special Characters" class="lookLikeButtons editButtons exitPage" href="buttons.jsp">
                                Edit Special Characters <i class="fa fa-edit"></i>
                            </a>
                            <a title="Edit XML Tags" class="lookLikeButtons editButtons exitPage" href="buttons.jsp">
                                Edit XML Tags <i class="fa fa-edit"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <div id="sidebar">
                    <div id="progress" class="ui-widget-content ui-corner-all">Select an option above</div>
                    <div id="lineResizing" class="ui-widget-content ui-corner-all">Your <span id="originalLine">original</span> pixel line is being resized by <span id="newLine">100</span>%.</div>
                </div>
            </div>
            
            <div id="startSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="get-started"></iframe>
            </div>
            
            <div id="frenchdocsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="about-french-documents"></iframe>
            </div>
        
            <div id="calligraphySplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="about-calligraphy-books"></iframe>
            </div>
        
            <div id="mapsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="about-historical-maps"></iframe>
            </div>
        
            <div id="scriptsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="scripts"></iframe>
            </div>
        
            <div id="documentsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="types-of-documents"></iframe>
            </div>
        
            <div id="conservationSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>          
                <iframe class="loadingIframe" data_src="manuscript-preservation"></iframe>
            </div>
        
            <div id="conventionsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="conventions"></iframe>
            </div>
        
            <div id="teachersSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="teaching"></iframe>
            </div>
        
            <div id="groupSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="group-work"> </iframe>
            </div>
        
            <div id="abbrevSplit" class="split" >
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="abbreviations"></iframe>
            </div>
        
            <div id="dictionarySplit" class="split iTool">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" id="frenchDictionary" data_src="dictionaries">
                </iframe>
            </div>
        
            <div id="glossarySplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="glossary"></iframe>
            </div>
        
            <div id="fInstitutionsSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="institutions"></iframe>
            </div>
        
            <div id="otherSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" data_src="reference-resources"></iframe>
            </div>
        
           <div id="linebreakSplit" class="ui-widget ui-widget-content split">
               <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <h3>Linebreak Existing Transcription (In Development)</h3>
           </div>
            <div id="compareSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div class="toolLinks">      
                    <select id="compareJump">
                        <option folioNum="0">Compare To</option>
                    </select>
                    <button class="showMe" onclick="restoreWorkspace();">Show Workspace</button>    
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>   
                    <button class="magnifyBtn" magnifyImg="compare" >Magnify</button>
                </div>

                <img class="compareImage" folioNum="1"></img>
            </div>
            <div id="previewSplit" class="split">
                <div class="toolLinks">      
                   <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                    <button class="showMe" onclick="restoreWorkspace();">Show Workspace</button>    
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>          
                </div> 
                <div id="previewDiv">

                </div>
            </div>
            <div id="fullPageSplit" class="split">  
                <div class="toolLinks">      
                    <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                    <button class="showMe" onclick="restoreWorkspace();">Show Workspace</button>    
                    <button class="hideMe" style="position: relative;" onclick="hideWorkspaceToSeeImage();" >Hide Workspace</button>     
                    <button class="magnifyBtn" style="position: relative;" magnifyImg="full" >Magnify</button>
                </div>
                <div id="fullPageSplitCanvas"><img id="fullPageImg" src="" /></div>
                            </div>
            <div id="essaySplit" class="split iTool">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" id="contextualEssay" data_src="essay">
                </iframe>
            </div>
            <div id="partialTransSplit" class="split iTool">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <iframe class="loadingIframe" id="partialTrans" data_src="transcription">
                </iframe>
            </div>
            <div id="helpSplit" class="split">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div id="helpHeaders">
                    <a href='#helpGlossary'> glossary </a>
                    <a href='#helpShortcuts'> shortcuts </a>
                    <a href='#helpTools'> tools </a>
                    <a href='#helpNavigation'> navigation </a>
                    <!--<a href='#helpDirectNavigation'> advanced </a>-->
                </div>
                <div id="helpContainer">
                    <div id="helpGlossary" class="helpSection">
                    <div class="helpSubsection">Glossary</div>
                    <dl>
                        <dt>Page</dt>
                        <dd>A single image and supporting interface. Some source images may contain partial or multiple folios.</dd>

                        <dt>Project</dt>
                        <dd>Collection of images designated for a specific group of users. Defaults to all images within a selected manuscript, but may be altered.</dd>

                        <dt>Manuscript</dt>
                        <dd>Collection of images on a repository. Often, but not necessarily exemplary of the artifact document.</dd>

                        <dt>Group</dt>
                        <dd>Collection of users associated with a single project. User permissions are controlled by site admins.</dd>

                        <dt>User</dt>
                        <dd>Entity intended to represent the human connected to a Paleography Transcription account.
                            Users login with the e-mail address associated with the Paleography Transcription account and are displayed to others by a first initial and last name.

                        <dt>Transcription</dt>
                        <dd>Usually referring to the textual data associated with an image region. Transcription metadata include specific location,
                            date of creation, and associated image data.</dd>

                        <dt>Transcription Area</dt>
                        <dd>Refers to the white textarea region where the user enters transcription text.</dd>

                        <dt>Parsing/Column Editing</dt>
                        <dd>Describes the automatic or manual process of logically splitting a page into rectangular regions to
                            designate individual lines for transcribing. Changes to parsing are saved in the history of a transcription.</dd>

                        <dt>History</dt>
                        <dd>Previous versions of transcriptions. Changes made to textual and parsing data are recorded.</dd>

                        <dt>Special Characters</dt>
                        <dd>Custom-coded buttons that automatically enter a unicode character
                            (typically one not included on the user's keyboard) into the transcription area.

                        <dt>Buttons</dt>
                        <dd>Typically refers to Special Character objects customizable on the Project Management page.
                            "Buttons" may also used in the generic sense to refer to a graphically distinct, clickable region which invokes an expected action.
                        </dd>
                        </dl>
                    </div>
                    <div id="helpShortcuts" class="helpSection">
                        <div class="helpSubsection">Keyboard Shortcuts</div>
                        <dl>

                            <dt>Insert the corresponding special character at the cursor location.</dt>
                            <dd><kbd>CTRL</kbd>+<kbd>1-9</kbd></dd>

                            <dt>Jump to the first line of the current page.</dt>
                            <dd><kbd>CTRL</kbd>+<kbd>HOME</kbd></dd>

                            <dt>Move forward through lines of transcription.</dt>
                            <dd><kbd>TAB</kbd></dd>
                            <dd><kbd>ALT</kbd>+<kbd>&dArr;</kbd></dd>

                            <dt>Move backward through lines of transcription.</dt>
                            <dd><kbd>SHIFT</kbd>+<kbd>TAB</kbd></dd>
                            <dd><kbd>ALT</kbd>+<kbd>&uArr;</kbd></dd>

                            <dt>Close any open tool & return to fullscreen transcription.</dt>
                            <dd><kbd>ESC</kbd></dd>

                            <dt>While Inspecting</dt>
                            <dd>+ or -</dd>
                            <dd>Each keystroke will adjust the magnification of the tool by .4x to fine tune the image result.</dd>

                            <dt>Help</dt>
                            <dd><kbd>F1</kbd></dd>

                            <dt>Browser Fullscreen</dt>
                            <dd><kbd>F11</kbd></dd>
                            <dd>Toggle fullscreen, eliminating browser and desktop toolbars.</dd>
                        </dl>
                    </div>
                    <div id="helpTools" class="helpSection">
                        <div class="helpSubsection">viewing options 
                            <!--<button type="button" onclick="Help.lightUp('.buttons')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>-->
                        </div>
                        <dl>
                            <dt>View the page image </dt>
                            <dd>To hide the work space to see the image hold <kbd>ALT</kbd>+<kbd>CTRL</kbd>.
                                While viewing, you can drag the image around with your mouse.
                                Release the keys to restore the screen. </dd>
                            <dt>Inspect</dt>
                            <dd>To view parts of the image under magnification click the Inspect button. 
                                <!--<button type="button" onclick="Help.lightUp('#magnify1')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>-->
                                Once in the inspect view you can use <kbd>+</kbd> and <kbd>-</kbd> to change the magnification.
                                Press <kbd>ESC</kbd> to return to the transcription view.</dd>
                            <dt>Peek-Zoom</dt>
                            <dd>To quickly fill the screen with the line being transcribed hold <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>.
                                This will enlarge the line being transcribed to fill the viewing window above the tool bar.
                                Release the keys to restore the screen. </dd>
                        </dl>
 
                        <div class="helpSubsection"> french paleography resources </div>
                        <dl>
                            <dt>Partial Transcription</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Background Essay</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>French Scripts and Hands </dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>About French Documents</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>French Institutions</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Historical Maps</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                        </dl>
                        
                        <div class="helpSubsection"> paleography information </div>
                        <dl>
                            <dt>Get Started</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Dictionaries</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Glossary</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Abbreviations</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Calligraphy Books</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Manuscript Preservation</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Teaching</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Group Work</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                            
                            <dt>Transcribing & Editing Conventions</dt>
                            <dd>DESCRIPTION NEEDED</dd>
                        </dl>

                        <div class="helpSubsection">page tools 
                            <!--<button type="button" onclick="Help.lightUp('#canvasControls')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>--> 
                        </div>
                        <p>These tools are designed to allow the user to manipulate the image to facilitate legibility.
                        All these adjustments are superficial and will not persist.</p>
                        <dl>
                            <div class="helpSubsection">image controls</div>
                            <dt>Grayscale </dt>
                            <dd>Presents the image as a grayscale image </dd>

                            <dt>Invert </dt>
                            <dd>Presents the image with its color inverted. </dd>

                            <dt>Brightness </dt>
                            <dd>A slider tool to raise and lower the brightness of the image.
                                <small>Note: not supported by all browsers.</small> </dd>

                            <dt>Contrast </dt>
                            <dd>A slider tool to raise and lower the contrast of the image.
                                <small>Note: not supported by all browsers.</small> </dd>
                        </dl>
                        <div class="helpSubsection">column/line controls</div>
                            <dl>
<!--                                <dt>Zen Line </dt>
                                <dd>Remove all line information and just focus on the line you are looking at. </dd>-->
                                
                                <dt>Minimal Lines </dt>
                                <dd>Reduce all lines to their minimal form (only a single line will show, not the box) </dd>
                                
                                <dt>Show Lines </dt>
                                <dd>Toggle the text column lines on and off. </dd>

                                <dt>Show Labels </dt>
                                <dd>Toggle the text letter/number labels next to each line on and off. </dd>

                                <dt>Change Line Color </dt>
                                <dd>Click to change the color of the lines and labels to improve visibility. </dd>

                                <dt>Edit Columns </dt>
                                <dd>Open the column editing/parsing interface to adjust and edit the columns and lines.  This is only available to administrators. </dd>
                            </dl>

                    <div class="helpSubsection"> other tools </div>
                        <dl>
<!--                            <dt>Line History </dt>
                            <dd>Lists the previous saved versions of the line boundaries and transcription text.
                                Mouseover the history entries to reveal options to revert to a previous version.
                            </dd>-->

                            <dt>Preview Transcription </dt>
                            <dd>Reveal the transcription text on the previous, current, and following pages.
                                Edit text in the transcription workspace or within the tool. </dd>

                            <dt>Compare Pages </dt>
                            <dd>View other pages from this project. Use the inspection tool to take a closer look.  Lines are not shown for image viewing ease. </dd>

                            <dt>View Full Page</dt>
                            <dd>Shrink the image down so you can see the whole thing.  Show transcriptions on top of it.</dd>
                        </dl>
                        
                        <div class="helpSubsection">custom characters</div>
                        <dl>
                            <dt>Custom Character Entry </dt>
                            <dd>To use Custom Characters
<!--                                <ol>
                                    <li>Expand the Characters tray 
                                        <button type="button" onclick="Help.lightUp('#toggleChars')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>
                                    </li>
                                    <li>Click on the desired character to insert it on the text field.</li>
                                </ol>
                            </dd>-->

                            <dt>Edit the Custom Characters </dt>
                            <dd>Click the Edit Special Characters button on the administrator parsing interface 
                                <!--<button type="button" onclick="Help.lightUp('.editButtons')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>--> 
                            </dd>

<!--                            <dt>XML Tag Entry </dt>
                            <dd>XML tags can always be hand-encoded by the user as they transcribe but XML Tags can be set up for ease of insertion. </dd>

                            <dt>To use XML Tags </dt>

                            <dd>Expand the XML Tag drawer 
                                <button type="button" onclick="Help.lightUp('#toggleXML')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button> 
                            </dd>
                            <dd>Highlight the text and click the desired XML tag button in the XML Tag tray to wrap the tag around the selection.</dd>
                            <dd>Insert as you type by clicking the XML tag button, adding the opening tag at the cursor
                                and put a closing tag <span class="tags ui-corner-all right ui-state-error no-point">reminder</span>
                                in the bottom right of the transcription text entry box.
                            </dd>
                            <dd>
                                To close the tag, place the cursor at the desired end point and click the reminder. Use the "x" to dismiss unwanted reminders.
                            </dd>-->
                        </dl>                            
                    </div>
                    <div id="helpNavigation" class="helpSection">
                        <div class="helpSubsection">navigation</div>
                        <dl>
                            <dt>Next Line
                            <!--<button type="button" onclick="Help.lightUp('#trimPage')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>-->
                            </dt>
                            <dd>Step forward through the page transcription one line at a time</dd>
                            <dt>Prev Line
                            <!--<button type="button" onclick="Help.lightUp('#trimPage')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>-->
                            </dt>
                            <dd>Step forward through the page transcription one line at a time</dd>
                            <dt>Jump to page 
                            <!--<button type="button" onclick="Help.lightUp('#pageJump')" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>-->
                            </dt>
                            <dd>Select any page in the current project.</dd>
                            <dt>Prev Page 
                            <!--<button type="button" onclick="Help.lightUp('#prevPage'); Help.lightUp('#prevCanvas');" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>-->
                            </dt>
                            <dd>Step back through the project one page at a time.</dd>
                            <dt>Next Page 
                            <!--<button type="button" onclick="Help.lightUp('#nextPage'); Help.lighUp('#nextCanvas');" class="reveal">Reveal on Screen <i class="fa fa-location-arrow"></i></button>-->
                            </dt>
                            <dd>Step forward through the project one page at a time.</dd>
                        </dl>
                    
                        <div class="helpSubsection"> header bar links </div>
                        <dl>
                            <dt>
                                Paleography Home
                            </dt>
                            <dd>
                                Go to the French Paleography home page.
                            </dd>
                            <dt>
                                Projects
                            </dt>
                            <dd>
                                Go to the My Transcriptions page for French Paleography.
                            </dd>
                            <dt>Contact</dt>
                            <dd>
                                Go to the French Paleography contact page
                            </dd>
                            <dt>Help</dt>
                            <dd>
                                Toggle this help module. 
                            </dd>
                        </dl>
                    </div>
<!--                    <div id="helpDirectNavigation" class="helpSection">
                        <div class="helpSubsection"> advanced </div>
                        <dl>
                            <dt>http://t-pen.org/TPEN/manifest/{projectID}</dt>
                            <dd>Shows the SharedCanvas Manifest for this project.</dd>
                            <dt>http://t-pen.org/TPEN/project/{projectID}</dt>
                            <dd>Shows the SharedCanvas Manifest for this project.</dd>
                            <dt>http://t-pen.org/TPEN/project.jsp?projectID={projectID}</dt>
                            <dd>Go directly to project management for this project.</dd>
                            <dt>http://t-pen.org/TPEN/transcription.html?projectID={projectID}</dt>
                            <dd>Go directly to the transcription interface for this project.</dd>
                            <dt>http://t-pen.org/TPEN/groups.jsp?projectID={projectID}</dt>
                            <dd>View or Manipulate the users associated with this project.</dd>
                        </dl>
                    </div>-->
                </div> 
            </div>
            <div id='controlsSplit' class='split' style="width:200px;max-width:200px;overflow:auto;">
                <div style="text-align: center;" class="fullScreenTrans"><i class="fa fa-share fa-flip-vertical"></i></div>
                <div class="controlOrganizer">
                    <button style="margin-bottom: 8px;" class="block" onclick="resetImageTools();" title="Reset Tools">
                    Reset to Defaults
                    </button>
                    <header> Image Controls </header>

                    <button which="grayscale" class="block" onclick="toggleFilter('grayscale');" title="Grayscale">
                        Grayscale
                        <i class="fa fa-picture-o" style="color: #999;background: #DDD;border-radius: 2px;"></i>
                    </button>
                    <button which="invert" class="block" onclick="toggleFilter('invert');">
                        Invert
                        <i class="fa fa-picture-o" style="background: #FFF;border-radius: 2px;color: #000;"></i>
                    </button>
                    <div id="imageToolSliders" class="imgTool">
                        Brightness  <i class="fa fa-sun-o"></i>
                        <div id="brightnessSlider"></div>
                        Contrast  <i class="fa fa-adjust"></i>
                        <div id="contrastSlider"></div>
                    </div>
                    <header> Column Controls</header>
                    <button role="button" id="minimalLines" class="block" onclick="toggleMinimalLines();">Minimal Lines</button>
                    <button role="button" id="zenLine" class="block" onclick="toggleZenLine();">Zen Line *beta</button>
                    <button id="showTheLines" role="button" class="block selected" onclick="toggleLineMarkers();">
                        Lines
                    </button>
                    <button id="showTheLabels" role="button" class="block selected" onclick="toggleLineCol();">
                        Labels
                    </button>
                    <button role="button" id="markerColors" class="block" onclick="markerColors();">Change Line Color</button>
                    <button role="button" id="parsingBtn" title="Redraw the lines on this page" class='block'>
                        Edit Columns
                        <i class="fa fa-barcode fa-rotate-90"></i>
                    </button>

                    <header>
                        Keyboard Shortcuts
                    </header>
                    <div style="text-align: left;">
                        <strong>View/Move Image</strong><br>
                        <kbd>CTRL</kbd>+<kbd>ALT</kbd>: hold to temporarily hide the workspace and drag around your page image
                    </div>
                    <div style="text-align:left;">
                        <strong>Peek-Zoom</strong><br>
                        <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>: peek-zoom into the current line of transcription
                    </div>
                    <div style="text-align:left;">
                        <strong>Zoom Lock</strong><br>
                        <kbd>Zoom Lock</kbd> button fires peek-zoom but stays locked in on the line until you click the <kbd>Zoom Lock</kbd> button again.
                    </div>
                </div>
            </div>
            <div style="clear:both"></div>
        </div>
        <div id="zoomDiv" class="ui-corner-all"></div>
        <div id="ruler1"></div><div id="ruler2"></div>
        <div id="genericIssue" class="ui-widget ui-corner-all ui-widget-content">
            <h2 class="ui-widget-header ui-corner-all">Data Error</h2>
            <p>
                There was an issue saving some of your data.  Please refresh the page to resume your activity.  If you continue to see this error
                please contact the T&#8209;PEN Admin.
            </p>
            <div class="clear right buttons">
                <button class="ui-button tpenButton" onclick="document.location.reload();">OK</button>
            </div>
        </div>
        <div id="overlay" class="ui-widget-overlay">
            <div id="overlayNote">Click the page to return</div>
        </div>
        <div id="location" class="ui-widget-content ui-corner-tr">
        </div>
        <div class="trexHead"></div>
        <div id="saveEditsOverlay">
            <div id="localParsingChangesNotice">
                <div id="localParsingChangesMsg">  </div>
                <button onclick="commitLocalChangesToServer(true);">Save And Leave</button>
                <button onclick="commitLocalChangesToServer();">Save And Stay</button>
                <button onclick="discardLocalChanges(true);">Discard And Leave</button>
                <button onclick="discardLocalChanges();">Discard And Stay</button>
                <button onclick="keepParsing();">Continue Editing</button>
            </div>
            <div id="localParsingChangesSavingNotice">
                <div id="localParsingChangesSavingMsg"> Saving... </div>
                <div class="turnLoader"><img src="images/loading2.gif" /></div>
            </div>
        </div>
        <div class="shadow_overlay"></div>
        <div id="helpVideoArea"  class="ui-widget ui-corner-all ui-widget-content">
            <div id="closeHelpVideo" onclick="closeHelpVideo();"> X </div>
            <h2 class="ui-widget-header ui-corner-all">Help Video Player</h2>
            <div class="i_contain">
                <iframe  id="helpVideo" src="" frameborder="0" allowfullscreen> </iframe>
            </div>
        </div>
        <noscript>
            <div id="noscript">
                You are blocking scripts on this page. T-PEN uses 
                <code>googleapis.com</code> and <code>javascript</code> 
                for necessary functionality.
            </div>
            <div class="trexHead" style="display:block"></div>
        </noscript>
    </body>
    <head>
        <!-- Must make sure this page does not cache as there are constant changes getting new data ids -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
        <meta http-equiv="Pragma" content="no-cache"/>
        <meta http-equiv="Expires" content="-1"/>
    </head>
</html>
<script>
    var theProjectID = -1;
    var keyHoldStop = false;
    
    //Page load event triggers and attached here.
    $(document).ready(function(){
        setPaleographyLinks();
        attachWindowResize();
        $("iframe").on('load', function (){
            $(this).removeClass("loadingIframe");
        });
        //Stop page from being out of wack after following a help header link
        $("#helpHeaders a").click(function(){
            setTimeout(function(){
                document.body.scrollTop = document.documentElement.scrollTop = 0;
            },1);
        });
        $("#imgTop, #imgBottom").css("height", "400px");
        $("#imgTop img, #imgBottom img").css("height", "400px");
        $("#imgTop img, #imgBottom img").css("width", "auto");
        //$('.transcriptionImage').attr('src', "images/loading2.gif"); //background loader if there is a hang time waiting for image
        //check if logged in
        var user = "";
        var url = "geti";
        $.ajax({
            url: url,
            type: "GET",
            dataType: "json",
            success: function(data){
//                console.log("user data");
//                console.log(data);
                if(data.uname && data.uname !== ""){
                    user = '<i class="fa fa-user"></i> '+data.uname;
                    loggedInUser = true;
                    creatorID = data.uid;
                    $("#trimCurrentUser").html(user);
                    $("#trimCurrentUser").attr("title",data.uname);
                    var theURL = window.location.href;
                    if (theURL.indexOf("projectID=") > -1){
                        var projID = getURLVariable("projectID");
                        theProjectID = parseInt(projID);
                        $(".editButtons").attr("href", "buttons.jsp?projectID="+theProjectID);
                        $("#transcriptionText").val(projID);
                        $("#loadBtn").click();
                    }
                    else{
                        $('#transcriptionTemplate').hide();
                        $('#setTranscriptionObjectArea').show();
                        $(".instructions").show();
                        $(".hideme").show();
                    }
                }
                else{
                    $("#trimCurrentUser").html("No User");
                    loggedInUser = false;
                    var theURL = window.location.href;
                    var projID = theURL.substring(theURL.indexOf("projectID=")+10);
                    if (theURL.indexOf("projectID=") > -1){
                        theProjectID = parseInt(projID);
                        alert("You must be logged in to view project "+projID);
                        redirectToPaleographyHome();
                    }
                    $('#transcriptionTemplate').hide();
                    $("#transTemplateLoading").hide();
                    $('#setTranscriptionObjectArea').show();
                    $(".instructions").show();
                    $(".hideme").show();
                    $("#parsingBtn").unbind("click");
                    $("#parsingBtn").attr("onclick","");
                    $("#parsingBtn").click(function(){
                        alert("You must be logged in to correct line parsing.  Log in and refresh the page to correct parsing.");
                    });
                }
                //only get iframes after confirmed user authentication
                
            },
            error: function(jqXHR,error, errorThrown) { 
                $("#trimCurrentUser").html("No User");
                loggedInUser = false;
                var theURL = window.location.href;
                var projID = theURL.substring(theURL.indexOf("projectID=")+10);
                if (theURL.indexOf("projectID=") > -1){
                    alert("You must be logged in to view project "+projID);
                    redirectToPaleographyHome();
                }
                $("#transTemplateLoading").hide();
                $('#transcriptionTemplate').hide();
                $('#setTranscriptionObjectArea').show();
                $(".instructions").show();
                $(".hideme").show();
                $("#parsingBtn").unbind("click");
                $("#parsingBtn").attr("onclick","");
                $("#parsingBtn").click(function(){
                    alert("You must be logged in to correct line parsing.  Log in and refresh the page to correct parsing.");
                });
            }
        });


        //get all project metadata so that we can get the project and user tools. 
        //$(".split").find('iframe').css("height", window.innerHeight+"px");
        $('select').find('option:eq(0)').prop("selected",true); //stops certain bugs caused by previously selected dropdown options.  
        $('select').removeAttr("disabled");
        $("#pageJump").on("change",function(){
            var parsing = false;
            if($("#parsingDiv").is(":visible")){
                parsing = true;
            }
            var a = $(this).find("option:selected");
            var b = a.attr("folioNum");
            pageJump(b, parsing);
        });
         $("#compareJump").on("change",function(){
            var a = $(this).find("option:selected");
            var b = a.attr("folioNum");
            compareJump(b);
        });
         $("#splitScreenTools").on("change",function(event){
            var a = $(this).find("option:selected");
            var b = a.attr("splitter");
            splitPage(event,b);     
        });

        $('#transcriptionFile').on("change", function(event){;
            var selectedFile = event.target.files[0];
            var reader = new FileReader();
            var result = $('#transcriptionText');
            reader.onload = function(event){
              var fileContent = event.target.result;
              result.html(fileContent);
              $('#transcriptionTemplate').hide();
            };
            reader.readAsText(selectedFile);
        });
        
        $("#helpMe").click(function(event){
            splitPage(event, "help");
        });

//        $(".fullScreenTrans").click(function(){
//            fullPage(true, false);
//        });
        
        $("#charactersPopin").on("change", function(event){
            var val = $("#charactersPopin").val();
            addchar(val, "");
        });
        
        $("#xmlTagPopin").on("change", function(event){
            var val = $("#xmlTagPopin").val();
            addchar(val, "");
        });

        $(".magnifyBtn").click(function(event){
            if ($(this).hasClass("ui-state-active")){
                $('#zoomDiv').hide();
                restoreWorkspace();
                isMagnifying = false;
                $(document).off("mousemove");
                $(this).removeClass("ui-state-active");
            } else {
                $(this).addClass("ui-state-active");
                isMagnifying=true;
                magnify($(this).attr("magnifyImg"),event);
            }
        });
        
        $("#imgTop, #imgBottom").hover(function(){
            if(!controlsMemory.minLines){
                //var color = colorThisTime.replace(".4", "1");
                $('.activeLine').css('box-shadow', '0px 0px 15px 8px '+colorThisTime);
                $('.activeLine').css('opacity', '1');
            }
        }
        , function(){
            if(!controlsMemory.minLines){
                var color2 = colorThisTime.replace(".4", "1");
                $('.activeLine').css('box-shadow', '0px 0px 15px 8px '+color2);
                $('.activeLine').css('opacity', '.75');
            }
        });

        document.addEventListener("mousewheel", function(e){
            if(isMagnifying){
                event.preventDefault();
                var wDelta = e.wheelDelta < 0 ? 'down' : 'up';
                if(wDelta === "up"){
                    zoomMultiplier += .4;
                    $(document).mousemove();
                }
                else{
                    zoomMultiplier -= .4;
                    $(document).mousemove();
                }
                $("#zoomat").text(Math.round(zoomMultiplier*10)/10+"x");
            }
        });

        $(document)
            .dblclick(function(){
                if(isMagnifying){
                    stopMagnify();
                }
            })
            .keydown(function(event){
                event = event || window.event;
                var charCode = event.keyCode || event.which;
                var ctrlDown = false,
                ctrlKey = 17,
                cmdKey = 91;
                var inForm = $(document.activeElement).is('.theText');
                if(isMagnifying){
                    //back out
                    if ((charCode === 109) || (charCode === 189) || (charCode === 173) ){ //173  = - in firefox
                        if(zoomMultiplier > .5){
                            zoomMultiplier -= .4;
                            $(document).trigger('mousemove');
                        }
                    }
                    //ease in
                    else if ((charCode === 107) || (charCode === 187) || (charCode === 61)){ // 61 = + in firefox
                        if(zoomMultiplier < 10){
                           zoomMultiplier += .4;
                           $(document).trigger('mousemove');
                        }
                    }
                    //esc
                    else if(charCode === 27){
                        stopMagnify();
                    }
                    else {

                    }
                    $("#zoomat").text(Math.round(zoomMultiplier*10)/10+"x");
                }
                else if (charCode == 112) { //F1 for help
                    event.preventDefault();
                    event.stopPropagation();
                }
                else if (charCode === 13 && (liveTool !=="parsing")){ //enter
                    if (event.shiftKey || event.altKey) return true;
                    //Linebreak.moveTextToNextBox();
                    if(inForm){
                        event.preventDefault();
                        event.stopPropagation();
                    }
                }
                else if (charCode === 9 && (liveTool !=="parsing")){ // tab
                    //TAB hijack to keep behavior as expected
                    if(inForm){
                        event.preventDefault();
                        event.stopPropagation();
                    }
                }
                else if (charCode == 18 || event.altKey && (liveTool !=="parsing")){
                   //console.log('ALT KEY');
                   if(event.altKey&&event.ctrlKey || event.altKey&&event.metaKey){
                       // hide workspace and move image
                       toggleMoveImage(event);
                   }
                   else if(charCode === 38){ //up.  Go to prev line.  Dont fire is user is holding key
                       if(!keyHoldStop) previousTranscriptlet();
                       keyHoldStop = true;
                   }
                   else if(charCode === 40){ //down. Go to next line. Dont fire is user is holding key
                       if(!keyHoldStop) nextTranscriptlet();
                       keyHoldStop = true;
                   }
                }
                else if (charCode === 27){
                    //Esc during any active tool means stop the tool.  In this case, our only worry is moving the image around.  We may add others later.
                    $("#imgTop, #imgBottom").unbind("mousemove");
                    $("#imgTop, #imgBottom").unbind("mousedown");
                    $("#imgTop, #imgBottom").unbind("mouseup");
                    //still need hover event on imgTop
                    $("#imgTop").css("cursor", "default");
                    $("#imgBottom").css("cursor", "default");
                    $(".magnifyBtn").removeClass("selected");
                    $("#moveImage").removeClass("selected");
                    $(".transcriptlet").children("textarea").removeClass("imageMove").removeAttr("disabled");
                    if(isPeeking && zoomLock){
                        toggleLocking();
                        peekZoom(true, {});
                    }
                    else if(liveTool == "parsing"){
                        unsetParsingInterface();
                       
                    } 
                    else if(liveTool && liveTool !== "none"){ 
                        //Cancel any live tool and go full page mode
                         fullPage(false, false);
                    }

                }
                else if (event.ctrlKey || event.metaKey && (liveTool !=="parsing")) { //ctrl
                    //This is also how you select a new tab in the browser.
                    if(charCode >= 49 && charCode <= 57){ //insert a special char
                        event.preventDefault();
                        event.stopPropagation();
                        //find the index in the special chars field and insert it.
                        var hotkey = $("#charactersPopin").children().eq(String.fromCharCode(charCode)-1);
                        hotkey.click(); //populating to the text field fires in onclick to this element, we have to register the change.
                    }
                    else if(event.ctrlKey && charCode === 36){ //HOME key.  Jump to first line.
                        event.preventDefault();
                        event.stopPropagation();
                        if($("div[pair='A1']").length){
                            $("div[pair='A1']").click();
                        }
                    } 
                    else if (event.shiftKey && !isPeeking && !isMagnifying && !zoomLock) {
                        // Peek-Zoom
                        peekZoom(false, {});
                    }
                }
                else {

                }
            })
            .keyup(function(event){
                if(isMagnifying){
                    return event;
                }
                event = event || window.event;
                var charCode = event.keyCode || event.which;
                if (charCode == 112) { //F1 for help
                    event.preventDefault();
                    //DO NOT pull up the help if the user is using another tool that is taking up the screen.  It breaks the interface..  
                    if(liveTool === "none"){
                        splitPage(event, "help");
                    }
                    else if(liveTool === "help"){
                        //F1 should toggle help, not just show.  Handle that here. 
                        fullPage(false, false);
                    }
                }
                else if(charCode == 18){
                    $("#imgTop, #imgBottom").css("cursor", "default");
                    $("#imgTop, #imgBottom").unbind("mousemove");
                    $("#imgTop, #imgBottom").unbind("mousedown");
                    $("#imgTop, #imgBottom").unbind("mouseup");
                }
                else if (charCode === 13 && (liveTool !=="parsing")){ //enter
                    event.preventDefault();
                    var inForm2 = $(document.activeElement).is('.theText');
                    if (event.shiftKey || event.altKey || !inForm2) return true;
                    nextTranscriptlet();
                    //Linebreak.moveTextToNextBox();
                    
                }
                else if (charCode === 9 && (liveTool !=="parsing")){ // tab
                //TAB hijack to keep behavior as expected
                    event.preventDefault();
                    event.stopPropagation();
                    var inForm = $(document.activeElement).is('.theText');
                    if(inForm){
                        if(event.shiftKey) previousTranscriptlet();
                        else nextTranscriptlet();
                    }
                }
                else if(charCode == 38 || charCode == 40){
                    keyHoldStop = false;
                }
                else if(isPeeking && (!event.shiftKey || !(event.ctrlKey||event.metaKey)) && !zoomLock){
                    // cancel Peek-Zoom, only if user does not have zoom lock setting active.
                    peekZoom(true, {});
                }
                else if(toggleMove && (!event.altKey || !event.ctrlKey || !event.metaKey)){
                    //cancel show and/or move image.  Must do this here because it is possible the user never moves the image and moveImg() won't handle the cancel case.
                    //Do not check against tpen.screen.isMoving, just make sure we are not peeking (they share the ctrlKey or metaKey, so they both tend to want to fire).
                    toggleMoveImage(false);
                }
            });

            $("#parsingBtn").click(function(){
                if(isFullscreen)isUnadjusted = true;
                isFullscreen = false;
                hideWorkspaceForParsing();
                $("#confirmParsingInst").show();
                $("#parsingBtn").css("box-shadow", "");
            });
            $("#canvasControls").click(function(event){
               splitPage(event, "controls");
            });
            
            $(".workspaceHandle").mousedown(function(event){moveWorkspace(event);})
            .css("cursor","n-resize");
    
            $(".parsingToolButtons").children("span").click(function(event){
                var show = $(this).attr("show");
                $("#imgTop").unbind("mousemove");
                $("#imgTop").unbind("mousedown");
                $("#imgTop").unbind("mouseup");
                $("#imgTop").css("cursor", "default");
                $("#imgBottom").css("cursor", "default");
                $(".parsing").removeClass("adjustable");
                $(".parsing").unbind('mousemove');
                $("#ruler1").hide();
                $("#ruler2").hide();
                $(".parsingColumn").off();
                $(".parsingColumn").unbind();
                var thisID = $(this).attr("id");
                $(".parsingToolButtons").find(".tpenButton").removeClass("selected");
                $(this).addClass("selected");
                if (thisID == "createColumn" || thisID == "destroyColumn" || thisID=="clearColumns" || thisID=="adjustColumn") {
                    $("#addLines").removeClass("active");
                    $("#removeLines").removeClass("active");
                    $("#ctrlColumnsInst").find(".startHide").hide();
                    $("#"+show).fadeIn(800);
                    $("#ctrlColumnsInst").find(".activeParsingTool").fadeIn(800);
                    $("#ctrlLinesInst").find(".activeParsingTool").fadeOut(800);
                    $(".parsing").unbind();
                    $(document).unbind("mousedown");
                    $(document).unbind("mousemove");
                    $(document).unbind("mouseup");
                    linesToColumns();
                    if(thisID == "adjustColumn"){
                        adjustColumn(event);
                    }
                    else if (thisID == "createColumn"){
                        $.each($(".parsingColumn"), function(){
                            $(this).removeClass("parsingColumnSelected");
                        });
                        var isCreating = true;
                        //adjustColumn(event);
                        //console.log("New or reparse column");
                        var offset = $('#imgTop').offset();
                        var point = {};
                        var deltaPoint = {x:0,y:0};
                        $(document).bind({
                                mousedown: function(event){
                                    //This bit of mouse down ensures it only fires on left mouse click.
                                    event = event || window.event;
                                    if(event.pageY <= offset.top || event.pageX <= offset.left || event.pageX >= (offset.left + $("#imgTop").width())){ //If you try to draw off of imgTop....
                                        return false;
                                    }
                                    if ("buttons" in event) {
                                        if(!event.buttons === 1){
                                            return false;
                                        }
                                    }
                                    else{
                                        var check = event.which || event.button;
                                        if(check!==1){
                                            return false;
                                        }
                                    }

                                    event.preventDefault();
                                    var newCol = "<div id='newCol' class='newColumn parsingColumn ui-resizable' style='z-index:1000;'></div>";
                                    point = {x:event.pageX - offset.left,y:event.pageY - offset.top};
                                    $(newCol).insertBefore($("#imgTop img")).css({
                                        'position'  : 'absolute',
                                        'top': point.y,
                                        'left': point.x,
                                        'min-width' : "5px",
                                        'min-height': "5px"
                                    });
                                    //}

                                },
                                mousemove:  function(event){
                                    event.preventDefault();
                                    deltaPoint = {
                                        x: event.pageX-offset.left-point.x,
                                        y: event.pageY-(point.y)
                                    };
                                    if (deltaPoint.x < 0) {
                                      // right to left drawing
                                      $("#newCol").css("left", point.x + deltaPoint.x);
                                    }
                                    if (deltaPoint.y < 0) {
                                      // bottom to top drawing
                                      $("#newCol").css("top", point.y  + deltaPoint.y);
                                    }
                                    $("#newCol").css({
                                      "width": Math.abs(deltaPoint.x),
                                      "height": Math.abs(deltaPoint.y) - 32 //header (.topTrim)
                                    });
                                },
                                mouseup:    function(event){
                                    event.preventDefault();
                                    var $newCol = $("#newCol");
                                    if(event.pageY <= offset.top || event.pageX <= offset.left || event.pageX >= (offset.left + $("#imgTop").width())){ //If you try to draw off of imgTop....
                                        $newCol.remove();
                                        return false;
                                    }
                                    $("#parsingCover").show();
                                    if (!isCreating){
                                        $(document).unbind("mousemove");
                                        $(document).unbind("mousedown");
                                        $(document).unbind("mouseup");
                                        $("#imgTop").css("cursor", "default");
                                        $("#imgBottom").css("cursor", "default");
                                        return true;
                                    }
                                    
                                    $newCol.attr({
                                        "newline"       : true,
                                        "newcol"        : true,
//                                        "linetop"       : parseFloat($newCol.css("top")) / $("#imgTop").height() * 100,
//                                        "lineleft"      : parseFloat($newCol.css("left")) / $("#imgTop").width() * 100,
//                                        "linewidth"     : $newCol.width() / $("#imgTop").width() * 100,
//                                        "lineheight"    : $newCol.height() / $("#imgTop").height() * 100,
                                        "startid"        : "",
                                        "endid"          : "",
                                        "hastranscription": false,
                                        id: ""
                                    });
                                    $newCol.css("background-color","transparent");
                                    // Prevent tiny columns on accident
                                    if (parseInt($newCol.width())+parseInt($newCol.height()) < 12) {
                                        $newCol.remove();
                                        $("#parsingCover").hide();
                                        return true;
                                    }
                                    isAddingLines = true;
                                    var newY = parseFloat($newCol.css("top")) / $("#imgTop").height() * 100;
                                    var newX = parseFloat($newCol.css("left")) / $("#imgTop").width() * 100;
                                    var newH = $newCol.height() / $("#imgTop").height()* 100;
                                    var newW = $newCol.width() / $("#imgTop").width() * 100;

                                    //The column is now a line, so put that into the UI and save it to the DB.
                                    var columnIsLine =$(
                                    "<div class='parsing newColumn' style='\n\
                                        top:"+newY+"%; \n\
                                        left:"+newX+"%; \n\
                                        height:"+newH+"%; \n\
                                        width:"+newW+"%; \n\
                                        z-index : -10;\n\
                                        ' lineserverid=''\n\
                                        linetop='"+newY+"'\n\
                                        lineleft='"+newX+"'\n\
                                        lineheight='"+newH+"'\n\
                                        linewidth='"+newW+"'>\n\
                                    </div>");
                                    
                                    if(isCreating){
                                        saveNewLine(null,columnIsLine);
                                        //TODO FIXME here, we need to set lineserverid
                                        $("#imgTop").append(columnIsLine);
                                    }
                                    //adjustColumn(); //Do this so that the new column is adjustable.
//                                    $(document).ajaxStop(function(){
//                                        $("#createColumn").click()
//                                        .unbind("ajaxStop");
//                                        isCreating = false;
//                                        
//                                    });
                                    //$("#imgTop").unbind("mousemove");
                                    //$("#imgTop").unbind("mousedown");
                                    //$("#imgTop").unbind("mouseup");
                                    //$(".newColumn").removeClass("newColumn");
                                    $("#imgTop").css("cursor", "default");
                                    $("#imgBottom").css("cursor", "default");
                                }

                        });
                    }
                    else if (thisID === "destroyColumn") {
                      //prep for column adjustment
                      $.each($(".parsingColumn"), function(){
                            $(this).removeClass("parsingColumnSelected");
                        });
                      $(".parsingColumn").bind({
                        mouseenter: function() {
                          $(this).addClass("parsingColumnSelected");
                        },
                        mouseleave: function() {
                          $(this).removeClass("parsingColumnSelected");
                        },
                        click: function() {
                          removeColumn($(this));
                          
                        }
                      });
                    }
                    else if (thisID === "clearColumns") {
                            //prep for column adjustment
                            var columnSet = $(".parsingColumn");
                            columnSet.addClass("parsingColumnSelected");
                            var columnText = (columnSet.size() === 1) ? "Destroy This Column" : "Destroy "+columnSet.size()+" Columns";
                            $(".destroyPage").html('<span class="left ui-icon ui-icon-circle-close"></span>'+columnText+'')
                            .bind('click', function(){destroyPage();})
                    }
                }
                else if (thisID == "addLines" || thisID == "removeLines" || thisID == "adjustLines" || thisID == "mergeLines") {
                    $("#ctrlLinesInst").find(".startHide").hide();
                    $("#"+show).fadeIn(800);
                    $("#ctrlColumnsInst").find(".activeParsingTool").fadeOut(800);
                    $("#ctrlLinesInst").find(".activeParsingTool").fadeIn(800);
                    $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                    $(".parsing").css("z-index", "5");
                    $('.parsing').unbind();
                    $(".parsing").css('cursor','default');
                    $(".parsingColumn").remove();
                    $(document).unbind("mousedown");
                    $(document).unbind("mousemove");
                    $(document).unbind("mouseup");
                    if (thisID == "adjustLines") {
                        $("#addLines").removeClass("active");
                        $("#removeLines").removeClass("active");
                        //prep for adjustment
                        $("#ruler1").hide();
                        $("#ruler2").hide();
                        var thisLineID = -1;
                        var originalW = 1;
                        var thisLine;
                        $(".parsing").addClass("adjustable").removeClass("line");
                        if($(".adjustable").hasClass("ui-resizable")){
                          $(".adjustable").has(".ui-resizable").resizable("enable");
                        } 
                        else {
                          $(".adjustable").resizable({
                            handles: "e",
                            containment: 'parent',
                            start: function(event, ui) {
                              originalW = ui.originalSize.width;
                              newW = ui.size.width;
                              $("#progress").html("Resizing Line").fadeIn();
                              $("#lineResizing").show();
                              $("#originalLine").html(originalW);
                              $("#newLine").html(Math.round(100 * (newW / originalW)));
                              $("#sidebar").fadeIn();
                              thisLine = $(".ui-resizable-resizing");
                            },
                            resize: function(event, ui) {
                              newW = ui.size.width;
                              $("#newLine").html(Math.round(100 * (newW / originalW)));
                            },
                            stop: function(event, ui) {
                              $("#progress").html("Line Resized - Saving...");
                              var thisLineW = parseFloat(thisLine.attr("linewidth")) * (ui.size.width / originalW);
                              thisLine.attr("linewidth", thisLineW);
                              //console.log("update line with ID: "+thisLineID);
                              updateLine(thisLine, true, null);       
                              $("#progress").html("Line Saved").delay(3000).fadeOut(1000);
                              $("#lineResizing").delay(3000).fadeOut(1000);
                            }
                          });
                        }
                    }
                    if (thisID == "addLines"){
                        //writeLines($("#imgTop img"));
                        $("#addLines").addClass("active");
                        $("#removeLines").removeClass("active");
                        $("#mergeLines").removeClass("active");
                        isAddingLines = true;
                        $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                        $(".parsing").bind({
                            mouseenter: function(){
                                applyRuler($(this), false);
                            },
                            mouseleave: function(){
                                removeRuler($(this));
                            },
                            click: function(event){
                                lineChange($(this), event, false);
                            }
                        });

                    }
                    if (thisID == "removeLines" || thisID == "mergeLines"){
                        $("#"+thisID).addClass("active");
                        $("#addLines").removeClass("active");
                        var deleteFlag = false;
                        if(thisID === "removeLines"){
                            deleteFlag=true;
                        }
                        //prep for column adjustment
                        //writeLines($("#imgTop img"));
                        isAddingLines = false;
                        $(".parsing").bind({
                            mouseenter: function(){
                                applyRuler($(this), deleteFlag);
                            },
                            mouseleave: function(){
                                removeRuler($(this));
                            },
                            click: function(event){
                                lineChange($(this), event, deleteFlag);
                            }
                        });
                        $("#imgTop").children(".line").addClass("parsing").removeClass("line");
                    }
                };
            });
           
        
        $(".accordion").children("span")
        .append("<span class='ui-icon ui-icon-triangle-1-e left'></span>")
        .click(function(event){
        //if(!isMember && !permitParsing)return false;
        $("#imgTop").unbind("mousemove");
        $("#imgTop").unbind("mousedown");
        $("#imgTop").unbind("mouseup");
        $("#imgTop").css("cursor", "default");
        $("#imgBottom").css("cursor", "default");
        $(".parsing").unbind('mousemove');
        $("#imgTop").children(".parsing").removeClass("adjustable");
        $(".destroyPage").unbind();
        $(".tpenButton").removeClass("ui-state-active");
        $("#ruler1").hide();
        $("#ruler2").hide();
        var thisID = $(this).attr("id");
        if (!$(this).next("div").is(":visible")) {
            $(this).siblings("div").not($(this).next("div")).slideUp();
            $(this).addClass("ui-state-active")
                .children(".ui-icon-triangle-1-e").switchClass("ui-icon-triangle-1-e","ui-icon-triangle-1-s").end()
                .siblings("span").removeClass("ui-state-active")
                .children(".ui-icon-triangle-1-s").switchClass("ui-icon-triangle-1-s","ui-icon-triangle-1-e");          
            $(this).next("div").slideDown();
        }
        
        //Cannot find this anymore.  Is it clearColumns now?
        if (thisID === "reparseColumns") {
                //load the adjustment tool and then show the reparsing instructions
                $(".parsingColumn").removeClass("parsingColumnSelected");
                var columnSet = $(".parsingColumn");
                $("#reparseColumn").html('<span class="left ui-icon ui-icon-refresh"></span>Submit '+columnSet.size()+' for Reparsing');
                $("#reparseColumn").bind('click', function(){
                    reparseColumns();
                });
            }
        }); 
        
         $("#brightnessSlider").slider({
            orientation: "horizontal",
            range: "min",
            max: 200,
            min: 0,
            value: 100,
            slide: imageSlider,
            change: imageSlider
        });
        $("#contrastSlider").slider({
            orientation: "horizontal",
            range: "min",
            max: 200,
            min: 0,
            value: 100,
            slide: imageSlider,
            change: imageSlider
        });
        
//        $("#previewSplit")
//        .on("click",".previewText,.previewNotes",function(){edit(this);})
//        .on("click","#previewNotes",function(){
//            if($(this).hasClass("ui-state-active")){
//                $(".previewNotes").hide();
//                $("#previewNotes")
//                    .text("Show Notes")
//                    .removeClass("ui-state-active");
//            } else {
//                $(".previewNotes").show();
//                $("#previewNotes")
//                    .text("Hide Notes")
//                    .addClass("ui-state-active");
//            }
//            scrollToCurrentPage();
//        });
    });
    
/*
 * This is a result of needing to /delete successful calls from an array of deferred calls where at least one failed.
 * The normal deferred process will return fail() on the first deferred fail() in a master deferred object.
 * We need to master deferred object fail() to wait until all deferred objects complete to make sure we have
 * The correct array of things to delete.  This feels a bit hacky, but research shows I am not the only one
 * to code themselves into this corner, and every solution I found was a bit hacky because the natural behavior
 * around deferred arrays does not support what I want.  
 * 
 * Originally, I had a solution that used --count in the deferred loops, this seems to use that same idea.
 * 
 * http://jsfiddle.net/InfinitiesLoop/yQsYK/51/
 * https://stackoverflow.com/questions/5518181/jquery-deferreds-when-and-the-fail-callback-arguments
 * https://github.com/jquery/api.jquery.com/issues/49
 */
$.whenAll = function( firstParam ) {
    var args = arguments,
        sliceDeferred = [].slice,
        i = 0,
        length = args.length,
        count = length,
        rejected,
        deferred = length <= 1 && firstParam && jQuery.isFunction( firstParam.promise )
            ? firstParam
            : jQuery.Deferred();
    
    function resolveFunc( i, reject ) {
        return function( value ) {
            rejected |= reject;
            args[ i ] = arguments.length > 1 ? sliceDeferred.call( arguments, 0 ) : value;
            if ( !( --count ) ) {
                // Strange bug in FF4:
                // Values changed onto the arguments object sometimes end up as undefined values
                // outside the $.when method. Cloning the object into a fresh array solves the issue
                var fn = rejected ? deferred.rejectWith : deferred.resolveWith;
                fn.call(deferred, deferred, sliceDeferred.call( args, 0 ));
            }
        };
    }
    
    if ( length > 1 ) {
        for( ; i < length; i++ ) {
            if ( args[ i ] && jQuery.isFunction( args[ i ].promise ) ) {
                args[ i ].promise().then( resolveFunc(i), resolveFunc(i, true) );
            } else {
                --count;
            }
        }
        if ( !count ) {
            deferred.resolveWith( deferred, args );
        }
    } else if ( deferred !== firstParam ) {
        deferred.resolveWith( deferred, length ? [ firstParam ] : [] );
    }
    return deferred.promise();
};

</script>
